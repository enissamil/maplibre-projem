<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Etiket Listesi</title>
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.7.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.7.0/dist/maplibre-gl.js'></script>
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; }
        #sidebar {
            width: 35%;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
        }
        #map {
            flex: 1;
        }
        .city-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .city-item button {
            background: #0077cc;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .city-item button:hover {
            background: #005fa3;
        }
        .pagination {
            margin-top: 15px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Etiket Listesi</h2>
        <div id="city-list"></div>
        <div class="pagination">
            <button id="prev">Önceki</button>
            <button id="next">Sonraki</button>
        </div>
    </div>
    <div id="map"></div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/streets/style.json?key=VuAYstDz4tzTEPewnaXd',
            center: [28.9784, 41.0082],
            zoom: 5
        });

        let cities = [];
        let currentPage = 0;
        const pageSize = 10;
        let markers = [];

        async function loadCities() {
            try {
                const response = await fetch("http://localhost:8080/api/cities/allCities");
                cities = await response.json();
                renderPage();
                renderMarkers();
            } catch (error) {
                console.error("Şehirler alınamadı:", error);
            }
        }

        function renderPage() {
            const listContainer = document.getElementById("city-list");
            listContainer.innerHTML = "";

            const start = currentPage * pageSize;
            const end = start + pageSize;
            const pageCities = cities.slice(start, end);

            pageCities.forEach(city => {
                const div = document.createElement("div");
                div.className = "city-item";
                div.innerHTML = `
                    <span>${city.name}</span>
                    <div>
                        <button onclick="editCity(${city.id}, '${city.name}')">Edit</button>
                        <button onclick="deleteCity(${city.id})">Delete</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        function editCity(id, currentName) {
            const newName = prompt("Yeni ismi girin:", currentName);
            if (newName && newName.trim() !== "") {
                fetch(`http://127.0.0.1:8080/api/cities/updateName/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newName })
                })
                .then(response => {
                    if (response.ok) {
                        alert("✅ Şehir ismi güncellendi!");
                        cities = cities.map(c => c.id === id ? { ...c, name: newName } : c);
                        renderPage();
                        renderMarkers();
                    } else {
                        alert("❌ Güncelleme başarısız!");
                    }
                })
                .catch(error => {
                    console.error("Hata:", error);
                    alert("⚠️ Sunucuya bağlanırken hata oluştu.");
                });
            }
        }




        async function deleteCity(id) {
            if (!confirm("Bu şehri silmek istediğinize emin misiniz?")) return;

            try {
                const response = await fetch(`http://localhost:8080/api/cities/id/${id}`, { method: "DELETE" });
                if (response.ok) {
                    cities = cities.filter(c => c.id !== id);
                    renderPage();
                    renderMarkers();
                } else {
                    alert("Silme işlemi başarısız oldu!");
                }
            } catch (error) {
                console.error(error);
            }
        }

        function renderMarkers() {
            // Önceki markerları temizle
            markers.forEach(marker => marker.remove());
            markers = [];

            cities.forEach(city => {
                const marker = new maplibregl.Marker()
                    .setLngLat([city.longitude, city.latitude])
                    .setPopup(new maplibregl.Popup({ offset: 25 }).setText(city.name))
                    .addTo(map);
                markers.push(marker);
            });
        }

        document.getElementById("prev").addEventListener("click", () => {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
            }
        });

        document.getElementById("next").addEventListener("click", () => {
            if ((currentPage + 1) * pageSize < cities.length) {
                currentPage++;
                renderPage();
            }
        });

        loadCities();
    </script>
</body>
</html>
